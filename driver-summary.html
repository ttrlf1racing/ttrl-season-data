<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TTRL Multi-Season Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #050608;
      color: #f5f5f5;
    }

    header {
      background: linear-gradient(to bottom, #000000 0, #050608 70%);
      padding: 16px 24px 14px;
      border-bottom: 3px solid #ff0000;
    }
    .header-top {
      display: flex;
      align-items: stretch;
      justify-content: space-between;
      gap: 18px;
    }
    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .logo-img {
      height: 60px;
      width: auto;
      display: block;
      filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.8));
      transition: transform 0.25s ease-out;
    }
    .header-left-text h1 {
      margin: 0;
      font-size: 22px;
    }
    .header-left-text p {
      margin: 4px 0;
      color: #c5c6c7;
      font-size: 13px;
    }
    #fileSelect {
      padding: 3px 6px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #3b4252;
      background: #050608;
      color: #f5f5f5;
    }

    .header-centre {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px 14px;
      border-radius: 12px;
      background: #050608;
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(107, 114, 128, 0.7);
      min-height: 70px;
    }
    .header-title-row {
      display: flex;
      gap: 6px;
      align-items: baseline;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-weight: 800;
      font-size: 18px;
      white-space: nowrap;
    }
    .header-title-red {
      color: #ff1a1a;
    }
    .header-title-blue {
      color: #1d4ed8;
    }
    .header-title-yellow {
      color: #facc15;
    }
    .header-subline {
      margin-top: 3px;
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.9;
      text-align: center;
      white-space: nowrap;
    }

    .header-meta {
      font-size: 12px;
      text-align: right;
      color: #9ca3af;
      min-width: 195px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    main {
      padding: 20px 24px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .cards {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    }
    .card {
      background: #10151f;
      padding: 12px 16px;
      border-radius: 6px;
      min-width: 160px;
      border-top: 3px solid #ffcf00;
    }
    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      color: #c5c6c7;
    }
    .card-value {
      font-size: 20px;
      margin-top: 4px;
    }

    h2 {
      margin-top: 24px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 4px;
      font-size: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th,
    td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #222831;
    }
    th {
      background: #11151f;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: #0b0f18;
    }
    tr:hover td {
      background: #151b26;
    }

    #driversTable th,
    #driversTable td {
      font-size: 12px;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
    }
    #driversTable th:nth-child(1),
    #driversTable td:nth-child(1) {
      width: 160px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 6px;
      align-items: center;
    }
    .filters input,
    .filters select,
    .filters button {
      padding: 4px 6px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #3b4252;
      background: #050608;
      color: #f5f5f5;
    }
    .filters button {
      cursor: pointer;
      background: #11151f;
    }
    .filters button:hover {
      background: #1d2535;
    }
    .filters label {
      font-size: 13px;
      color: #c5c6c7;
    }

    .section-description {
      font-size: 13px;
      color: #c5c6c7;
      margin-top: 4px;
    }

    .tab-btn {
      background: #11151f;
      border: 1px solid #3b4252;
      color: #f5f5f5;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .tab-btn.active {
      background: #007bff;
      border-color: #007bff;
    }
    .tab-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    section[data-view] {
      display: none;
    }
    section[data-view].active {
      display: block;
    }

    .scroll-body {
      max-height: 520px;
      overflow-y: auto;
      display: block;
      margin-right: 2px;
    }
    .scroll-body table {
      border-collapse: collapse;
      width: 100%;
    }
    .scroll-body thead,
    .scroll-body tbody,
    .scroll-body tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    .driver-layout {
      display: flex;
      gap: 16px;
      margin-top: 10px;
    }
    .driver-layout-main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .driver-card {
      position: relative;
      background: radial-gradient(circle at top left, #1f2937 0, #050608 55%);
      border-radius: 10px;
      padding: 18px 20px 14px;
      border: 1px solid #3b82f6;
      border-left: 4px solid #ef4444;
      box-shadow: 0 0 18px rgba(59, 130, 246, 0.45);
      overflow: hidden;
    }
    .driver-card.primary-champ {
      border-left-color: #22c55e;
    }
    .driver-card::before {
      content: "";
      position: absolute;
      inset: -40px;
      background: radial-gradient(
        circle at top right,
        rgba(251, 191, 36, 0.06),
        transparent 60%
      );
      opacity: 0.9;
      pointer-events: none;
    }
    .driver-card-header {
      position: relative;
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 8px;
    }
    .driver-card-logo {
      position: relative;
      width: 72px;
      height: 72px;
      border-radius: 999px;
      object-fit: cover;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.9);
      flex-shrink: 0;
    }
    .driver-card h3 {
      position: relative;
      margin: 0 0 4px;
      font-size: 22px;
    }
    .driver-handle {
      position: relative;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .driver-meta,
    .driver-statline {
      position: relative;
      font-size: 14px;
      color: #d1d5db;
      margin-bottom: 6px;
    }
    .driver-chip {
      position: relative;
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      font-size: 12px;
      margin: 0 4px 4px 0;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }
    .driver-chip.primary {
      border-color: #f59e0b;
      background: linear-gradient(135deg, #f59e0b, #b45309);
      color: #000;
    }

    .driver-stat-pill {
      position: relative;
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 12px;
      margin: 0 4px 4px 0;
    }

    .driver-row-selected td {
      background: #1d2935 !important;
    }

    .driver-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .driver-modal.open {
      display: flex;
    }
    .driver-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(6px);
    }
    .driver-modal-card {
      position: relative;
      max-width: 1100px;
      width: 96%;
      transform: translateY(10px);
      transition: transform 150ms ease-out, opacity 150ms ease-out;
      opacity: 0;
    }
    .driver-modal.open .driver-modal-card {
      transform: translateY(0);
      opacity: 1;
    }
    .driver-modal .driver-card {
      padding: 22px 24px 18px;
      border-radius: 16px;
    }
    .driver-modal-close {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #e5e7eb;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
    }

    .muted {
      color: #9ca3af;
      font-size: 13px;
    }

    .driver-cta {
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 6px;
      background: linear-gradient(90deg, #ff1a1a, #1d4ed8, #facc15);
      color: #000;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .driver-cta-icon {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      background: #000;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #facc15;
      font-size: 10px;
    }

    .track-subtabs {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .track-subtab-btn {
      font-size: 12px;
      padding: 4px 10px;
    }

    .track-hover {
      position: relative;
      cursor: help;
    }
    .track-hover-tooltip {
      position: absolute;
      left: 50%;
      top: 115%;
      transform: translateX(-50%);
      background: #020617;
      color: #e5e7eb;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      border: 1px solid #facc15;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease-out;
      z-index: 20;
    }
    .track-hover-tooltip::after {
      content: "";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: transparent transparent #facc15 transparent;
    }
    .track-hover:hover .track-hover-tooltip {
      opacity: 1;
    }

    .driver-subtabs {
      margin: 8px 0 10px;
      display: flex;
      gap: 8px;
    }
    .driver-subtab-btn {
      background: #11151f;
      border: 1px solid #3b4252;
      color: #f5f5f5;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .driver-subtab-btn.active {
      background: #007bff;
      border-color: #007bff;
    }

    .driver-details-grid {
      display: flex;
      gap: 10px;
    }
    .driver-details-col {
      flex: 0 0 220px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .driver-details-col-wide {
      flex: 1 1 auto;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dd-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #1f2937;
    }
    .dd-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .dd-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .dd-table tr td:first-child {
      color: #9ca3af;
    }
    .dd-table td {
      padding: 2px 0;
      border: none;
    }

    .dd-scroll {
      max-height: 150px;
      overflow-y: auto;
      font-size: 12px;
    }

    .dd-seasons-pill {
      padding: 3px 6px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #374151;
      margin: 0 4px 4px 0;
      display: inline-block;
    }
    .dd-seasons-pill span {
      color: #e5e7eb;
    }

    .dd-history-wrap {
      padding: 8px 6px;
    }
    .dd-history-columns {
      display: flex;
      gap: 8px;
    }
    .dd-history-col {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
    }
    .dd-history-scroll {
      max-height: 180px;
      overflow-y: auto;
      font-size: 12px;
    }
    .dd-history-item {
      padding: 2px 0;
      border-bottom: 1px solid #111827;
    }
    .dd-history-item:last-child {
      border-bottom: none;
    }
    .dd-history-event {
      color: #e5e7eb;
    }
    .dd-history-meta {
      color: #9ca3af;
      font-size: 11px;
    }

    @media (max-width: 900px) {
      .header-top {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-centre {
        width: 100%;
        align-items: flex-start;
        padding: 8px 10px;
      }
      .header-title-row {
        font-size: 16px;
        white-space: normal;
      }
      .header-subline {
        white-space: normal;
      }
      .header-meta {
        text-align: left;
        margin-top: 6px;
      }
      .logo-wrap {
        gap: 10px;
      }
      .logo-img {
        height: 54px;
      }
      .driver-layout {
        flex-direction: column;
      }
      .driver-details-grid {
        flex-direction: column;
      }
      .driver-details-col,
      .driver-details-col-wide {
        flex: 1 1 auto;
      }
    }

    @media (max-width: 600px) {
      .header-title-row {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
<input id="addSeasonFileInput" type="file" accept=".json,application/json" style="display:none" />
<header>
  <div class="header-top">
    <div class="logo-wrap">
      <img src="ttrl-logo.png" alt="TTRL logo" class="logo-img" />
      <div class="header-left-text">
        <h1 id="leagueTitle">TTRL Multi-Season Statistics</h1>
        <p id="raceDayLine">Choose race date to view</p>
        <div>
          <select id="fileSelect">
            <option value="">Select race date</option>
          </select>
        </div>
      </div>
    </div>
    <div class="header-centre">
      <div class="header-title-row">
        <span class="header-title-red">TTRL</span>
        <span class="header-title-blue">MULTI-SEASON</span>
        <span class="header-title-yellow">INSIGHTS</span>
      </div>
      <div class="header-subline">CROSS-ERA DRIVER &amp; TRACK STATS</div>
    </div>
    <div class="header-meta">
      <div id="fileMeta">No file loaded yet</div>
    </div>
  </div>
</header>

<main>
  <section id="overviewSection">
    <h2>Overview</h2>
    <div class="cards" id="overviewCards"></div>
  </section>

  <section id="viewSelector">
    <div class="filters" style="margin-top:0;">
      <label style="margin-right:8px;">View</label>
      <button class="tab-btn active" data-view="drivers">Drivers</button>
      <button class="tab-btn" data-view="driverSummary">Individual Driver Summary</button>
      <button class="tab-btn" data-view="tracks">Tracks</button>
      <button class="tab-btn disabled" data-view="driverTimes" aria-disabled="true">Driver Times coming soon</button>
    </div>
  </section>

  <!-- Drivers -->
  <section id="driversSection" data-view="drivers" class="active">
    <h2>Drivers</h2>
    <p class="section-description">
      Stats cover all seasons contained in the currently selected export.
    </p>

    <div class="driver-cta">
      <span class="driver-cta-icon">★</span>
      <span>Click a driver row to open their profile card.</span>
    </div>

    <div class="filters">
      <label>
        Search
        <input type="text" id="driverSearch" placeholder="Name, nationality, race num" />
      </label>
      <label>
        Min seasons
        <input type="number" id="minSeasons" min="1" value="1" style="width:70px" />
      </label>
      <label>
        Sort by
        <select id="driverSort">
          <option value="points">Total points</option>
          <option value="avgPoints">Avg pts</option>
          <option value="wins">Wins</option>
          <option value="podiums">Podiums</option>
          <option value="fastRace">Fast race laps</option>
          <option value="fastPole">Fast pole laps</option>
          <option value="clean">Clean %</option>
        </select>
      </label>
    </div>

    <div class="driver-layout">
      <div class="driver-layout-main">
        <div class="scroll-body">
          <table id="driversTable">
            <thead>
              <tr>
                <th>Driver</th>
                <th>Nat.</th>
                <th>Car number</th>
                <th>Seasons</th>
                <th>Races</th>
                <th>Total pts</th>
                <th>Avg pts</th>
                <th>Wins</th>
                <th>Podiums</th>
                <th>Fast race laps</th>
                <th>Fast pole laps</th>
                <th>Best champ pos</th>
                <th>Clean %</th>
                <th>Reliab. %</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="driverPager" class="filters" style="justify-content:space-between;margin-top:6px;">
          <div>
            <span id="driverPageInfo">Page 1 of 1</span>
          </div>
          <div>
            <button id="driverPrevPage" class="tab-btn" type="button">&lt; Prev</button>
            <button id="driverNextPage" class="tab-btn" type="button">Next &gt;</button>
            <select id="driverPageSize" style="margin-left:8px;">
              <option value="10">10 page</option>
              <option value="25" selected>25 page</option>
              <option value="50">50 page</option>
              <option value="100">100 page</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Driver modal with subtabs -->
  <div id="driverModal" class="driver-modal">
    <div class="driver-modal-backdrop"></div>
    <div class="driver-modal-card">
      <button id="driverModalClose" class="driver-modal-close">&times;</button>
      <div id="driverCard" class="driver-card">
        <div class="driver-card-header">
          <img id="driverAvatar" src="Drivers Avatars/default.png?v2" alt="Driver avatar" class="driver-card-logo" />
          <div>
            <div class="driver-handle">TTRL DRIVER PROFILE</div>
            <h3 id="dcName"></h3>
            <div class="driver-meta" id="dcMeta"></div>
            <div id="dcCats" style="margin-bottom:6px;"></div>
          </div>
        </div>

        <div class="driver-subtabs">
          <button class="driver-subtab-btn active" data-driver-view="summary">Summary</button>
          <button class="driver-subtab-btn" data-driver-view="details">Details</button>
        </div>

        <!-- Summary view -->
        <div id="driverSummaryView" data-driver-view="summary">
          <div class="driver-statline" id="dcSummary"></div>
          <div id="dcPills" style="margin-bottom:8px;"></div>

          <h4 style="margin:4px 0 4px;font-size:14px;">Season results</h4>
          <div style="max-height:320px;overflow-y:auto;">
            <table class="driver-seasons-table">
              <thead>
                <tr>
                  <th>Season</th>
                  <th>Pos</th>
                  <th>Pts</th>
                  <th>Races</th>
                  <th>Wins</th>
                  <th>Podiums</th>
                </tr>
              </thead>
              <tbody id="dcSeasonsTable"></tbody>
            </table>
          </div>
        </div>

        <!-- Details view -->
        <div id="driverDetailsView" data-driver-view="details" style="display:none;">
          <div class="driver-details-grid">
            <!-- Col 1 -->
            <div class="driver-details-col">
              <div class="dd-card">
                <div class="dd-title">Career</div>
                <table class="dd-table" id="ddCareerTable"></table>
              </div>
              <div class="dd-card">
                <div class="dd-title">Points</div>
                <table class="dd-table" id="ddPointsTable"></table>
              </div>
              <div class="dd-card">
                <div class="dd-title">Discipline</div>
                <table class="dd-table" id="ddDisciplineTable"></table>
              </div>
            </div>

            <!-- Col 2 -->
            <div class="driver-details-col">
              <div class="dd-card">
                <div class="dd-title">Races</div>
                <table class="dd-table" id="ddRacesTable"></table>
              </div>
              <div class="dd-card">
                <div class="dd-title">Performance</div>
                <table class="dd-table" id="ddPerformanceTable"></table>
              </div>
            </div>

            <!-- Col 3 -->
            <div class="driver-details-col-wide">
              <div class="dd-card">
                <div class="dd-title">Seasons</div>
                <div class="dd-scroll" id="ddSeasonsList"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- details -->
      </div>
    </div>
  </div>

  <!-- Individual Driver Summary -->
  <section id="driverSummarySection" data-view="driverSummary">
    <h2>Individual Driver Summary</h2>
    <p class="section-description">
      Detailed multiseason breakdown for a single driver: career, points, race and qualifying stats, and seasons.
    </p>

    <div class="filters">
      <label>
        Driver
        <select id="summaryDriverSelect">
          <option value="">Select driver</option>
        </select>
      </label>
    </div>

    <div id="driverSummaryContent" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
        <img id="summaryDriverAvatar" src="Drivers Avatars/default.png?v2" alt="Driver avatar"
             style="width:60px;height:60px;border-radius:999px;object-fit:cover;box-shadow:0 0 10px rgba(0,0,0,0.8);" />
        <div>
          <div class="driver-handle">TTRL DRIVER SUMMARY</div>
          <h3 id="summaryDriverName" style="margin:0;"></h3>
          <div id="summaryDriverMeta" class="driver-meta" style="margin:2px 0 0;"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-bottom:10px;">
        <span class="driver-stat-pill" id="summaryPillWins"></span>
        <span class="driver-stat-pill" id="summaryPillPodiums"></span>
        <span class="driver-stat-pill" id="summaryPillTitles"></span>
        <span class="driver-stat-pill" id="summaryPillAvgFinish"></span>
        <span class="driver-stat-pill" id="summaryPillClean"></span>
      </div>

      <div style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-bottom:10px;">
        <div class="dd-card">
          <div class="dd-title">Career</div>
          <table class="dd-table" id="sumCareerTable"></table>
        </div>
        <div class="dd-card">
          <div class="dd-title">Races</div>
          <table class="dd-table" id="sumRacesTable"></table>
        </div>
        <div class="dd-card">
          <div class="dd-title">Qualifications</div>
          <table class="dd-table" id="sumQualTable"></table>
        </div>
        <div class="dd-card">
          <div class="dd-title">Points</div>
          <table class="dd-table" id="sumPointsTable"></table>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:2fr;gap:10px;">
        <div class="dd-card">
          <div class="dd-title">Seasons</div>
          <div class="dd-scroll" id="sumSeasonsList"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tracks -->
  <section id="trackSection" data-view="tracks">
    <h2>Tracks</h2>
    <p class="section-description">
      Per-track fastest laps and season comparison across the export.
    </p>

    <div class="filters">
      <label>
        Track
        <select id="trackSelect">
          <option value="">All tracks</option>
        </select>
      </label>
    </div>

    <div class="track-subtabs">
      <button class="tab-btn track-subtab-btn active" data-track-view="details">Track Details</button>
      <button class="tab-btn track-subtab-btn" data-track-view="seasonCmp">Season Comparison</button>
    </div>

    <div id="trackDetailsView" data-track-view="details">
      <div class="scroll-body">
        <table id="trackTable">
          <thead>
            <tr>
              <th>Track</th>
              <th>Races</th>
              <th>Driver</th>
              <th>Race FL</th>
              <th>Driver</th>
              <th>Qual FL</th>
              <th>Max speed</th>
              <th>Avg pitstops</th>
              <th>SC + VSC</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="trackSeasonCmpView" data-track-view="seasonCmp" style="display:none;">
      <div class="scroll-body">
        <table id="trackSeasonCmpTable">
          <thead>
            <tr id="trackSeasonCmpHeader">
              <th>Track</th>
            </tr>
          </thead>
          <tbody id="trackSeasonCmpBody"></tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:6px;">
        Values show fastest race lap per season for each circuit.
        <span style="font-weight:600;color:#facc15;">Hover over any time to see the driver.</span>
      </p>
    </div>
  </section>

  <section id="driverTimesSection" data-view="driverTimes">
    <h2>Driver Times</h2>
    <p class="muted">
      This section is temporarily disabled while lap time data is finalised.
    </p>
  </section>
</main>

<script>
  let globalBaseData = null;
  const DRIVER_AVATAR_FOLDER = "Drivers Avatars";

  const EXPORT_FILES = [
    { value: "exportdata/sundayraces.json", label: "Sunday races" },
    { value: "exportdata/wedraces.json", label: "Wednesday races" },
    { value: "exportdata/t4.json", label: "T4 season data" }
  ];

  function getDriverAvatarSrc(driverName) {
    return DRIVER_AVATAR_FOLDER + "/" + driverName + ".png";
  }

  function populateFileSelect() {
    const select = document.getElementById("fileSelect");
    if (!select) return;
    while (select.options.length > 1) select.remove(1);
    EXPORT_FILES.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.value;
      opt.textContent = f.label;
      select.appendChild(opt);
    });
  }

  function formatLoadedMeta(meta) {
    const fileMetaEl = document.getElementById("fileMeta");
    if (!fileMetaEl) return;
    const exportedAt = meta && meta.exportedAt;
    if (!exportedAt) {
      fileMetaEl.textContent = "Last loaded export: unknown export time";
      return;
    }
    try {
      const d = new Date(exportedAt);
      fileMetaEl.textContent = "Last loaded export: " + d.toLocaleString();
    } catch {
      fileMetaEl.textContent = "Last loaded export: " + exportedAt;
    }
  }

  function buildPage(data) {
    globalBaseData = data;
    const meta = data.metadata || {};
    const multi = data.multiSeasonStatistics || {};
    const info = multi.multiSeasonInfo || {};
    const driversSrc = (multi.drivers && multi.drivers.multiSeasonDriverStatistics) || data.drivers || [];
    const tracksSrc = (multi.tracks && multi.tracks.multiSeasonTrackStatistics) || data.tracks || [];

    formatLoadedMeta(meta);

    const leagueName = (meta.leagueName || "").trim() || "TTRL";
    const msName = info.name || "All Seasons";
    document.getElementById("leagueTitle").textContent = leagueName + " – " + msName;

    const cardsEl = document.getElementById("overviewCards");
    cardsEl.innerHTML = "";
    [
      { title: "Seasons", value: info.seasonsCount },
      { title: "Completed seasons", value: info.completedSeasonsCount },
      { title: "Total drivers", value: info.totalDrivers },
      { title: "Total teams", value: info.totalTeams },
      { title: "Tracks", value: info.totalTracks }
    ].forEach(c => {
      if (c.value == null) return;
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML =
        "<div class='card-title'>" + c.title + "</div>" +
        "<div class='card-value'>" + c.value + "</div>";
      cardsEl.appendChild(div);
    });

    // ----- DRIVERS -----
    const driversTableBody = document.querySelector("#driversTable tbody");
    const dcName = document.getElementById("dcName");
    const dcMeta = document.getElementById("dcMeta");
    const dcCats = document.getElementById("dcCats");
    const dcSummary = document.getElementById("dcSummary");
    const dcPills = document.getElementById("dcPills");
    const dcSeasonsTable = document.querySelector("#dcSeasonsTable");
    const driverModal = document.getElementById("driverModal");
    const driverModalClose = document.getElementById("driverModalClose");
    const driverAvatar = document.getElementById("driverAvatar");

    function getDriverCategories(driverName) {
      const d = driversSrc.find(dr => (dr.driverName || "").toLowerCase() === String(driverName || "").toLowerCase());
      if (!d) return [];
      const cats = (d.driverInfo && d.driverInfo.categories) || d.categories;
      if (!cats) return [];
      if (Array.isArray(cats)) {
        return cats.map(c => String(c).trim()).filter(Boolean);
      }
      return String(cats)
        .split(",")
        .map(c => c.trim())
        .filter(Boolean);
    }

    function deriveDriverRow(d) {
      const infoD = d.driverInfo || {};
      const points = d.points || {};
      const racePositions = d.racePositions || {};
      const qualPositions = d.qualPositions || {};
      const standings = d.standings || {};
      const discipline = d.discipline || {};
      const participation = d.participation || {};

      const totalPoints = Number(points.totalPoints || 0);
      const avgPerMajor = Number(points.averagePerMajorRace || points.averagePerEvent || 0);
      const wins = Number(racePositions.wins || 0);
      const podiums = Number(racePositions.podiums || 0);
      const bestChampPos = standings.bestPosition || null;
      const cleanPct = discipline.cleanRacePercent != null ? discipline.cleanRacePercent : null;
      const reliabPct = discipline.reliabilityPercent != null ? discipline.reliabilityPercent : null;
      const seasonsPart = participation.seasonsParticipated || 0;
      const totalRaces = participation.totalRaces || participation.totalMajorRaces || 0;
      const fastRaceLaps = Number(racePositions.fastestRaceLaps || 0);
      const fastPoleLaps = Number(qualPositions.poles || 0);

      return {
        source: d,
        name: d.driverName || "",
        realName: infoD.realName || "",
        nationality: infoD.nationality || "",
        raceNumber: infoD.raceNumber || "",
        seasons: seasonsPart,
        races: totalRaces,
        totalPoints,
        avgPerMajor,
        wins,
        podiums,
        fastRaceLaps,
        fastPoleLaps,
        bestChampPos,
        cleanPct,
        reliabPct
      };
    }

    const driverRowsAll = driversSrc.map(deriveDriverRow);
    let selectedDriverName = null;
    let driverCurrentPage = 1;
    let driverPageSize = 25;

    // ---- INDIVIDUAL DRIVER SUMMARY ----
    const summarySelect = document.getElementById("summaryDriverSelect");
    const summaryContent = document.getElementById("driverSummaryContent");

    function populateSummarySelect() {
      if (!summarySelect) return;
      summarySelect.innerHTML = '<option value="">Select driver</option>';
      const sorted = driverRowsAll.slice().sort((a, b) => a.name.localeCompare(b.name));
      sorted.forEach(dr => {
        if (!dr.name) return;
        const opt = document.createElement("option");
        opt.value = dr.name;
        opt.textContent = dr.name;
        summarySelect.appendChild(opt);
      });
    }

    function fillSummaryTable(elId, rows) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.innerHTML = rows
        .map(r => {
          return (
            "<tr>" +
            "<td>" + r.label + "</td>" +
            "<td style='text-align:right'>" + (r.value ?? "") + "</td>" +
            "</tr>"
          );
        })
        .join("");
    }

    function renderDriverSummary(driverName) {
      if (!summaryContent) return;
      const row = driverRowsAll.find(d => d.name === driverName);
      if (!row) {
        summaryContent.style.display = "none";
        return;
      }

      const src = row.source;
      const infoD = src.driverInfo || {};
      const participation = src.participation || {};
      const standings = src.standings || {};
      const points = src.points || {};
      const racePositions = src.racePositions || {};
      const qualPositions = src.qualPositions || {};
      const discipline = src.discipline || {};
      const performance = src.performance || {};
      const seasons = (standings.seasonResults || []).slice();

      summaryContent.style.display = "";

      const nameEl = document.getElementById("summaryDriverName");
      const metaEl = document.getElementById("summaryDriverMeta");
      const avatarEl = document.getElementById("summaryDriverAvatar");
      if (nameEl) nameEl.textContent = row.name;
      if (metaEl) {
        metaEl.textContent =
          (infoD.nationality || "Nationality unknown") +
          " · #" +
          (infoD.raceNumber || "?") +
          " · " +
          (participation.seasonsParticipated || 0) +
          " seasons";
      }
      if (avatarEl) {
        const srcPath = getDriverAvatarSrc(row.name);
        const fallback = DRIVER_AVATAR_FOLDER + "/default.png?v2";
        avatarEl.onerror = function () {
          this.onerror = null;
          this.src = fallback;
        };
        avatarEl.src = srcPath;
        avatarEl.alt = row.name;
      }

      const pillWins = document.getElementById("summaryPillWins");
      const pillPods = document.getElementById("summaryPillPodiums");
      const pillTitles = document.getElementById("summaryPillTitles");
      const pillAvgFinish = document.getElementById("summaryPillAvgFinish");
      const pillClean = document.getElementById("summaryPillClean");

      if (pillWins) pillWins.textContent = "Wins " + (racePositions.wins || 0);
      if (pillPods) pillPods.textContent = "Podiums " + (racePositions.podiums || 0);
      if (pillTitles) pillTitles.textContent = "Titles " + (standings.championshipsWon || 0);
      if (pillAvgFinish)
        pillAvgFinish.textContent =
          "Avg finish " +
          (racePositions.averagePosition != null ? racePositions.averagePosition : "—");
      if (pillClean) {
        if (discipline.cleanRacePercent != null) {
          const v =
            typeof discipline.cleanRacePercent === "number" &&
            discipline.cleanRacePercent.toFixed
              ? discipline.cleanRacePercent.toFixed(0)
              : discipline.cleanRacePercent;
          pillClean.textContent = "Clean " + v + "%";
        } else {
          pillClean.textContent = "Clean —";
        }
      }

      // career
      fillSummaryTable("sumCareerTable", [
        { label: "Races", value: participation.totalRaces ?? "" },
        { label: "Seasons", value: participation.seasonsParticipated ?? "" },
        { label: "Titles", value: standings.championshipsWon ?? "" },
        { label: "Top 3", value: standings.top3Finishes ?? "" },
        { label: "Best standings", value: standings.bestPosition ?? "" },
        { label: "Avg standings", value: standings.averagePosition ?? "" }
      ]);

      // races
      fillSummaryTable("sumRacesTable", [
        { label: "Wins", value: racePositions.wins ?? "" },
        { label: "Podiums", value: racePositions.podiums ?? "" },
        { label: "Top 5", value: racePositions.top5 ?? "" },
        { label: "Top 10", value: racePositions.top10 ?? "" },
        {
          label: "Best finish",
          value:
            racePositions.bestPosition != null ? "P" + racePositions.bestPosition : ""
        },
        { label: "Avg finish", value: racePositions.averagePosition ?? "" },
        { label: "Avg grid", value: racePositions.averageGridPosition ?? "" },
        {
          label: "Avg pos change",
          value:
            racePositions.averagePositionChange != null
              ? (racePositions.averagePositionChange > 0 ? "+" : "") +
                racePositions.averagePositionChange
              : ""
        }
      ]);

      // qualifications
      fillSummaryTable("sumQualTable", [
        { label: "Poles", value: qualPositions.poles ?? "" },
        { label: "Front rows", value: qualPositions.frontRows ?? "" },
        { label: "Top 3", value: qualPositions.top3 ?? "" },
        {
          label: "Best qualifying",
          value:
            qualPositions.bestPosition != null ? "P" + qualPositions.bestPosition : ""
        },
        { label: "Avg position", value: qualPositions.averagePosition ?? "" },
        {
          label: "Pole rate",
          value:
            qualPositions.poleRatePercent != null
              ? qualPositions.poleRatePercent + "%"
              : ""
        }
      ]);

      // points
      fillSummaryTable("sumPointsTable", [
        { label: "Total points", value: points.totalPoints ?? "" },
        { label: "Avg per season", value: points.averagePerSeason ?? "" },
        { label: "Avg per race", value: points.averagePerMajorRace ?? "" },
        { label: "Avg per event", value: points.averagePerEvent ?? "" },
        {
          label: "Best season",
          value: points.bestSeasonPoints
            ? points.bestSeasonPoints + " (" + (points.bestSeasonName || "") + ")"
            : ""
        }
      ]);

      const seasonsListEl = document.getElementById("sumSeasonsList");
      if (seasonsListEl) {
        seasonsListEl.innerHTML = "";
        seasons
          .slice()
          .sort((a, b) =>
            String(a.seasonName || "").localeCompare(String(b.seasonName || ""))
          )
          .forEach(s => {
            const rowEl = document.createElement("div");
            rowEl.style.padding = "6px 0";
            rowEl.style.borderBottom = "1px solid #111827";
            rowEl.style.display = "grid";
            rowEl.style.gridTemplateColumns = "minmax(0,2fr) auto";
            rowEl.style.columnGap = "8px";
            rowEl.style.alignItems = "center";

            const left = document.createElement("div");
            const right = document.createElement("div");
            right.style.textAlign = "right";
            right.style.fontSize = "11px";

            const name = document.createElement("div");
            name.textContent = s.seasonName || "";
            name.style.fontSize = "13px";
            name.style.fontWeight = "600";

            const meta = document.createElement("div");
            meta.className = "dd-history-meta";

            const events = s.eventsCount != null ? s.eventsCount : s.racesCount;
            const races = s.racesCount != null ? s.racesCount : s.eventsCount;
            const pts = s.points != null ? s.points : "";
            const wins = s.wins != null ? s.wins : "";

            const parts = [];
            if (events) parts.push(events + " events");
            if (races) parts.push(races + " races");
            if (pts !== "") parts.push(pts + " pts");
            if (wins !== "") parts.push(wins + " W");
            meta.textContent = parts.join(" • ");

            left.appendChild(name);
            left.appendChild(meta);

            const badges = document.createElement("div");

            const posBadge = document.createElement("span");
            posBadge.className = "dd-seasons-pill";
            posBadge.textContent = s.position != null ? "P" + s.position : "—";
            badges.appendChild(posBadge);

            if (s.teamName) {
              const teamBadge = document.createElement("span");
              teamBadge.className = "dd-seasons-pill";
              teamBadge.textContent = s.teamName;
              badges.appendChild(teamBadge);
            }

            if (s.isOngoing || s.status === "Ongoing") {
              const ongoing = document.createElement("span");
              ongoing.className = "dd-seasons-pill";
              ongoing.textContent = "ONGOING";
              badges.appendChild(ongoing);
            }

            right.appendChild(badges);

            rowEl.appendChild(left);
            rowEl.appendChild(right);
            seasonsListEl.appendChild(rowEl);
          });
      }
    }

    populateSummarySelect();
    if (summarySelect) {
      summarySelect.addEventListener("change", e => {
        const name = e.target.value;
        if (!name) {
          if (summaryContent) summaryContent.style.display = "none";
        } else {
          renderDriverSummary(name);
        }
      });
    }

    function getFilteredDriverRows() {
      return driverRowsAll;
    }

    function renderDrivers() {
      const search = document.getElementById("driverSearch").value.toLowerCase();
      const minSeasons = Number(document.getElementById("minSeasons").value || 1);
      const sortKey = document.getElementById("driverSort").value;
      const rows = getFilteredDriverRows();

      const filtered = rows.filter(dr => {
        if ((dr.seasons || 0) < minSeasons) return false;
        const text =
          (dr.name || "") +
          " " +
          (dr.nationality || "") +
          " " +
          String(dr.raceNumber || "").toLowerCase();
        if (search && !text.toLowerCase().includes(search)) return false;
        return true;
      });

      const sorters = {
        points: (a, b) => b.totalPoints - a.totalPoints,
        avgPoints: (a, b) => b.avgPerMajor - a.avgPerMajor,
        wins: (a, b) => b.wins - a.wins,
        podiums: (a, b) => b.podiums - a.podiums,
        fastRace: (a, b) => b.fastRaceLaps - a.fastRaceLaps,
        fastPole: (a, b) => b.fastPoleLaps - a.fastPoleLaps,
        clean: (a, b) => (b.cleanPct || 0) - (a.cleanPct || 0)
      };
      filtered.sort(sorters[sortKey] || sorters.points);

      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / driverPageSize));
      if (driverCurrentPage > totalPages) driverCurrentPage = totalPages;
      if (driverCurrentPage < 1) driverCurrentPage = 1;
      const start = (driverCurrentPage - 1) * driverPageSize;
      const pageRows = filtered.slice(start, start + driverPageSize);

      driversTableBody.innerHTML = "";
      pageRows.forEach(dr => {
        const tr = document.createElement("tr");
        tr.dataset.driverName = dr.name;
        if (dr.name === selectedDriverName) tr.classList.add("driver-row-selected");
        tr.innerHTML =
          "<td>" + dr.name + "</td>" +
          "<td>" + (dr.nationality || "") + "</td>" +
          "<td>" + (dr.raceNumber || "") + "</td>" +
          "<td>" + (dr.seasons || 0) + "</td>" +
          "<td>" + (dr.races || 0) + "</td>" +
          "<td>" + (dr.totalPoints || 0) + "</td>" +
          "<td>" +
          (dr.avgPerMajor && dr.avgPerMajor.toFixed
            ? dr.avgPerMajor.toFixed(1)
            : dr.avgPerMajor || 0) +
          "</td>" +
          "<td>" + (dr.wins || 0) + "</td>" +
          "<td>" + (dr.podiums || 0) + "</td>" +
          "<td>" + (dr.fastRaceLaps || 0) + "</td>" +
          "<td>" + (dr.fastPoleLaps || 0) + "</td>" +
          "<td>" + (dr.bestChampPos || "") + "</td>" +
          "<td>" +
          (dr.cleanPct != null
            ? dr.cleanPct.toFixed
              ? dr.cleanPct.toFixed(1)
              : dr.cleanPct
            : "") +
          "</td>" +
          "<td>" +
          (dr.reliabPct != null
            ? dr.reliabPct.toFixed
              ? dr.reliabPct.toFixed(1)
              : dr.reliabPct
            : "") +
          "</td>";
        driversTableBody.appendChild(tr);
      });

      const infoEl = document.getElementById("driverPageInfo");
      if (infoEl) {
        infoEl.textContent =
          "Page " + driverCurrentPage + " of " + totalPages + " (" + total + " drivers)";
      }

      const prevBtn = document.getElementById("driverPrevPage");
      const nextBtn = document.getElementById("driverNextPage");
      if (prevBtn) prevBtn.disabled = driverCurrentPage <= 1;
      if (nextBtn) nextBtn.disabled = driverCurrentPage >= totalPages;
    }

    function renderDriverCard(driverName) {
      const rows = getFilteredDriverRows();
      const row = rows.find(d => d.name === driverName);
      if (!row) return;
      selectedDriverName = row.name;

      Array.from(driversTableBody.querySelectorAll("tr")).forEach(tr => {
        tr.classList.toggle(
          "driver-row-selected",
          tr.dataset.driverName === selectedDriverName
        );
      });

      const src = row.source;
      const infoD = src.driverInfo || {};
      const participation = src.participation || {};
      const standings = src.standings || {};
      let seasonsResults = (standings.seasonResults || []).slice();
      seasonsResults.sort((a, b) =>
        String(a.seasonName || "").localeCompare(String(b.seasonName || ""))
      );

      const cats = getDriverCategories(row.name);

      dcName.textContent = row.name;
      dcMeta.textContent =
        (infoD.nationality || "Nationality unknown") +
        " · #" +
        (infoD.raceNumber || "?") +
        " · " +
        (participation.seasonsParticipated || 0) +
        " seasons";

      if (driverAvatar) {
        const avatarSrc = getDriverAvatarSrc(row.name);
        const defaultSrc = DRIVER_AVATAR_FOLDER + "/default.png?v2";
        driverAvatar.onerror = function () {
          this.onerror = null;
          this.src = defaultSrc;
        };
        driverAvatar.src = avatarSrc;
        driverAvatar.alt = row.name;
      }

      dcCats.innerHTML = "";
      if (cats.length) {
        cats.forEach((c, idx) => {
          const span = document.createElement("span");
          span.className = "driver-chip" + (idx === 0 ? " primary" : "");
          span.textContent = c;
          dcCats.appendChild(span);
        });
      }

      dcSummary.textContent =
        "Best championship position " +
        (standings.bestPosition || "—") +
        " · Championships won " +
        (standings.championshipsWon || 0) +
        " · Total points " +
        (row.totalPoints || 0);

      const cardEl = document.getElementById("driverCard");
      if (cardEl) {
        cardEl.classList.remove("primary-champ");
        if ((standings.championshipsWon || 0) > 0) {
          cardEl.classList.add("primary-champ");
        }
      }

      dcPills.innerHTML = "";
      function makePill(label, value) {
        const span = document.createElement("span");
        span.className = "driver-stat-pill";
        span.textContent = label + " " + (value ?? "—");
        dcPills.appendChild(span);
      }
      makePill("Wins", row.wins || 0);
      makePill("Podiums", row.podiums || 0);
      const avgPtsPerRace =
        row.races ? (row.totalPoints || 0) / row.races : null;
      makePill(
        "Pts/race",
        avgPtsPerRace != null && avgPtsPerRace.toFixed
          ? avgPtsPerRace.toFixed(1)
          : avgPtsPerRace
      );
      makePill(
        "Clean %",
        row.cleanPct != null && row.cleanPct.toFixed
          ? row.cleanPct.toFixed(1)
          : row.cleanPct
      );

      dcSeasonsTable.innerHTML = "";
      seasonsResults.forEach(sr => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + (sr.seasonName || "") + "</td>" +
          "<td>" + (sr.position || "") + "</td>" +
          "<td>" + (sr.points || 0) + "</td>" +
          "<td>" + (sr.racesCount || 0) + "</td>" +
          "<td>" + (sr.wins || 0) + "</td>" +
          "<td>" + (sr.podiums || 0) + "</td>";
        dcSeasonsTable.appendChild(tr);
      });

      // DETAILS VIEW POPULATION
      const racePositions = src.racePositions || {};
      const qualPositions = src.qualPositions || {};
      const discipline = src.discipline || {};
      const performance = src.performance || {};
      const points = src.points || {};
      const seasons = (standings.seasonResults || []).slice();

      const fillTable = (elId, rows) => {
        const el = document.getElementById(elId);
        if (!el) return;
        el.innerHTML = rows
          .map(r => {
            return (
              "<tr>" +
              "<td>" + r.label + "</td>" +
              "<td style='text-align:right'>" + (r.value ?? "") + "</td>" +
              "</tr>"
            );
          })
          .join("");
      };

      // Career
      fillTable("ddCareerTable", [
        { label: "Races", value: participation.totalRaces ?? "" },
        { label: "Seasons", value: participation.seasonsParticipated ?? "" },
        { label: "Titles", value: standings.championshipsWon ?? "" },
        { label: "Top 3", value: standings.top3Finishes ?? "" },
        { label: "Best standings", value: standings.bestPosition ?? "" },
        { label: "Avg standings", value: standings.averagePosition ?? "" }
      ]);

      // Points
      fillTable("ddPointsTable", [
        { label: "Total points", value: points.totalPoints ?? "" },
        { label: "Avg per season", value: points.averagePerSeason ?? "" },
        { label: "Avg per race", value: points.averagePerMajorRace ?? "" },
        { label: "Avg per event", value: points.averagePerEvent ?? "" },
        {
          label: "Best season",
          value: points.bestSeasonPoints
            ? points.bestSeasonPoints + " (" + (points.bestSeasonName || "") + ")"
            : ""
        }
      ]);

      // Discipline
      fillTable("ddDisciplineTable", [
        { label: "DNFs", value: discipline.dnfCount ?? "" },
        { label: "DSQs", value: discipline.dsqCount ?? "" },
        {
          label: "Time penalties",
          value:
            discipline.totalPenaltySeconds != null
              ? discipline.totalPenaltySeconds + " s"
              : ""
        },
        { label: "Clean races", value: discipline.cleanRacesCount ?? "" },
        {
          label: "Clean %",
          value:
            discipline.cleanRacePercent != null
              ? (discipline.cleanRacePercent.toFixed
                  ? discipline.cleanRacePercent.toFixed(0)
                  : discipline.cleanRacePercent) + "%"
              : ""
        },
        {
          label: "Reliability",
          value:
            discipline.reliabilityPercent != null
              ? discipline.reliabilityPercent + "%"
              : ""
        }
      ]);

      // Races
      fillTable("ddRacesTable", [
        { label: "Wins", value: racePositions.wins ?? "" },
        { label: "Podiums", value: racePositions.podiums ?? "" },
        { label: "Top 5", value: racePositions.top5 ?? "" },
        { label: "Top 10", value: racePositions.top10 ?? "" },
        {
          label: "Best finish",
          value:
            racePositions.bestPosition != null ? "P" + racePositions.bestPosition : ""
        },
        { label: "Average finish", value: racePositions.averagePosition ?? "" },
        {
          label: "Avg grid",
          value: racePositions.averageGridPosition ?? ""
        },
        {
          label: "Avg pos change",
          value:
            racePositions.averagePositionChange != null
              ? (racePositions.averagePositionChange > 0 ? "+" : "") +
                racePositions.averagePositionChange
              : ""
        }
      ]);

      // Performance
      fillTable("ddPerformanceTable", [
        { label: "Fastest laps", value: performance.fastestLaps ?? "" },
        { label: "Laps led", value: performance.lapsLed ?? "" },
        {
          label: "Lead %",
          value:
            performance.leadPercentage != null
              ? performance.leadPercentage + "%"
              : ""
        },
        { label: "Total laps", value: performance.totalLaps ?? "" },
        { label: "Overtakes", value: performance.overtakes ?? "" }
      ]);

      // Seasons list – richer layout
      const seasonsListEl = document.getElementById("ddSeasonsList");
      if (seasonsListEl) {
        seasonsListEl.innerHTML = "";
        seasons
          .slice()
          .sort((a, b) =>
            String(a.seasonName || "").localeCompare(String(b.seasonName || ""))
          )
          .forEach(s => {
            const rowEl = document.createElement("div");
            rowEl.style.padding = "6px 0";
            rowEl.style.borderBottom = "1px solid #111827";
            rowEl.style.display = "grid";
            rowEl.style.gridTemplateColumns = "minmax(0,2fr) auto";
            rowEl.style.columnGap = "8px";
            rowEl.style.alignItems = "center";

            const left = document.createElement("div");
            const right = document.createElement("div");
            right.style.textAlign = "right";
            right.style.fontSize = "11px";

            const name = document.createElement("div");
            name.textContent = s.seasonName || "";
            name.style.fontSize = "13px";
            name.style.fontWeight = "600";

            const meta = document.createElement("div");
            meta.className = "dd-history-meta";

            const events = s.eventsCount != null ? s.eventsCount : s.racesCount;
            const races = s.racesCount != null ? s.racesCount : s.eventsCount;
            const pts = s.points != null ? s.points : "";
            const wins = s.wins != null ? s.wins : "";

            const parts = [];
            if (events) parts.push(events + " events");
            if (races) parts.push(races + " races");
            if (pts !== "") parts.push(pts + " pts");
            if (wins !== "") parts.push(wins + " W");
            meta.textContent = parts.join(" • ");

            left.appendChild(name);
            left.appendChild(meta);

            const badges = document.createElement("div");

            const posBadge = document.createElement("span");
            posBadge.className = "dd-seasons-pill";
            posBadge.textContent = s.position != null ? "P" + s.position : "—";
            badges.appendChild(posBadge);

            if (s.teamName) {
              const teamBadge = document.createElement("span");
              teamBadge.className = "dd-seasons-pill";
              teamBadge.textContent = s.teamName;
              badges.appendChild(teamBadge);
            }

            if (s.isOngoing || s.status === "Ongoing") {
              const ongoing = document.createElement("span");
              ongoing.className = "dd-seasons-pill";
              ongoing.textContent = "ONGOING";
              badges.appendChild(ongoing);
            }

            right.appendChild(badges);

            rowEl.appendChild(left);
            rowEl.appendChild(right);
            seasonsListEl.appendChild(rowEl);
          });
      }

      // Default to Summary tab each time modal opens
      document.querySelectorAll(".driver-subtab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-driver-view") === "summary");
      });
      document
        .querySelectorAll("[data-driver-view]")
        .forEach(el => (el.style.display = el.getAttribute("data-driver-view") === "summary" ? "" : "none"));

      if (driverModal) driverModal.classList.add("open");
    }

    document.querySelector("#driversTable").addEventListener("click", e => {
      const tr = e.target.closest("tr");
      if (!tr || !tr.dataset.driverName) return;
      renderDriverCard(tr.dataset.driverName);
    });

    if (driverModal && driverModalClose) {
      driverModalClose.addEventListener("click", () => driverModal.classList.remove("open"));
      driverModal.addEventListener("click", e => {
        if (e.target === driverModal) driverModal.classList.remove("open");
      });
    }

    document.getElementById("driverSearch").addEventListener("input", () => {
      driverCurrentPage = 1;
      renderDrivers();
    });
    document.getElementById("minSeasons").addEventListener("change", () => {
      driverCurrentPage = 1;
      renderDrivers();
    });
    document.getElementById("driverSort").addEventListener("change", () => {
      driverCurrentPage = 1;
      renderDrivers();
    });
    document.getElementById("driverPrevPage").addEventListener("click", () => {
      driverCurrentPage--;
      renderDrivers();
    });
    document.getElementById("driverNextPage").addEventListener("click", () => {
      driverCurrentPage++;
      renderDrivers();
    });
    document.getElementById("driverPageSize").addEventListener("change", e => {
      driverPageSize = Number(e.target.value || 25);
      driverCurrentPage = 1;
      renderDrivers();
    });

    renderDrivers();

    // ----- TRACKS -----
    const trackSelect = document.getElementById("trackSelect");
    const trackTableBody = document.querySelector("#trackTable tbody");
    const allSeasonNames = (multi.seasons || []).map(s => s.name || "").filter(Boolean);

    const trackRows = (tracksSrc || []).map(t => {
      const circuit = t.circuitName || t.trackName || "";
      const gen = t.generalStats || {};
      const raceStats = t.raceStats || {};
      const qualStats = t.qualificationStats || {};
      const fastestRaceLap = raceStats.fastestRaceLap || {};
      const fastestQualLap = qualStats.fastestQualLap || {};

      const seasonRaceMap = {};
      const flEntries = (raceStats.fastestRaceLapsBySeason || []).slice();
      flEntries.forEach(fl => {
        const sName = fl.seasonName || "All seasons";
        const current = seasonRaceMap[sName];
        if (!current || (fl.timeMs || 0) < (current.timeMs || 0)) {
          seasonRaceMap[sName] = {
            time: fl.time || "",
            timeMs: fl.timeMs || null,
            driverName: fl.driverName || ""
          };
        }
      });

      if (fastestRaceLap.time) {
        const sName = fastestRaceLap.seasonName || "All seasons";
        const current = seasonRaceMap[sName];
        if (!current || (fastestRaceLap.timeMs || 0) < (current.timeMs || 0)) {
          seasonRaceMap[sName] = {
            time: fastestRaceLap.time,
            timeMs: fastestRaceLap.timeMs || null,
            driverName: fastestRaceLap.driverName || ""
          };
        }
      }

      return { circuit, gen, raceStats, qualStats, fastestRaceLap, fastestQualLap, seasonRaceMap };
    });

    const trackNames = Array.from(new Set(trackRows.map(r => r.circuit))).sort();
    trackSelect.innerHTML = '<option value="">All tracks</option>';
    trackNames.forEach(name => {
      if (!name) return;
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      trackSelect.appendChild(opt);
    });

    function formatSC(gen, raceStats) {
      const totalSC = raceStats.totalSafetyCars != null ? raceStats.totalSafetyCars : 0;
      const totalVSC =
        raceStats.totalVirtualSafetyCars != null ? raceStats.totalVirtualSafetyCars : 0;
      return totalSC + " / " + totalVSC;
    }

    function renderTrackDetails() {
      const filterName = trackSelect.value;
      trackTableBody.innerHTML = "";
      trackRows
        .filter(r => !filterName || r.circuit === filterName)
        .forEach(r => {
          const gen = r.gen || {};
          const rs = r.raceStats || {};
          const qs = r.qualStats || {};
          const tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" + r.circuit + "</td>" +
            "<td>" + (gen.totalRaces || 0) + "</td>" +
            "<td>" + (rs.fastestRaceLap && rs.fastestRaceLap.driverName ? rs.fastestRaceLap.driverName : "") + "</td>" +
            "<td>" + (rs.fastestRaceLap && rs.fastestRaceLap.time ? rs.fastestRaceLap.time : "") + "</td>" +
            "<td>" + (qs.fastestQualLap && qs.fastestQualLap.driverName ? qs.fastestQualLap.driverName : "") + "</td>" +
            "<td>" + (qs.fastestQualLap && qs.fastestQualLap.time ? qs.fastestQualLap.time : "") + "</td>" +
            "<td>" + (rs.maxSpeed != null ? rs.maxSpeed + " km/h" : "") + "</td>" +
            "<td>" + (rs.avgPitstops != null ? rs.avgPitstops : "") + "</td>" +
            "<td>" + formatSC(gen, rs) + "</td>";
          trackTableBody.appendChild(tr);
        });
    }

    const cmpHeaderRow = document.getElementById("trackSeasonCmpHeader");
    const cmpBody = document.getElementById("trackSeasonCmpBody");

    function renderTrackSeasonCmp() {
      const filterName = trackSelect.value;
      cmpHeaderRow.innerHTML = "<th>Track</th>";
      allSeasonNames.forEach(sn => {
        const th = document.createElement("th");
        th.textContent = sn;
        cmpHeaderRow.appendChild(th);
      });

      cmpBody.innerHTML = "";
      trackRows
        .filter(r => !filterName || r.circuit === filterName)
        .forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = "<td>" + r.circuit + "</td>";
          allSeasonNames.forEach(sn => {
            const td = document.createElement("td");
            const entry = r.seasonRaceMap[sn];
            if (!entry || !entry.time) {
              td.textContent = "";
            } else {
              td.classList.add("track-hover");
              const span = document.createElement("span");
              span.textContent = entry.time;
              td.appendChild(span);
              if (entry.driverName) {
                const tip = document.createElement("div");
                tip.className = "track-hover-tooltip";
                tip.textContent = entry.driverName;
                td.appendChild(tip);
              }
            }
            tr.appendChild(td);
          });
          cmpBody.appendChild(tr);
        });
    }

    renderTrackDetails();
    renderTrackSeasonCmp();

    trackSelect.addEventListener("change", () => {
      renderTrackDetails();
      renderTrackSeasonCmp();
    });

    // top-level view switching
    document.querySelectorAll("#viewSelector .tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.classList.contains("disabled")) return;
        document.querySelectorAll("#viewSelector .tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const view = btn.getAttribute("data-view");
        document.querySelectorAll("section[data-view]").forEach(sec => {
          sec.classList.toggle("active", sec.getAttribute("data-view") === view);
        });
      });
    });

    // track subtabs
    document.querySelectorAll(".track-subtab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".track-subtab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const view = btn.getAttribute("data-track-view");
        document.querySelectorAll("[data-track-view]").forEach(el => {
          if (el.id === "trackDetailsView" || el.id === "trackSeasonCmpView") {
            el.style.display = el.getAttribute("data-track-view") === view ? "" : "none";
          }
        });
      });
    });

    // driver subtabs inside modal
    document.querySelectorAll(".driver-subtab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".driver-subtab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const view = btn.getAttribute("data-driver-view");
        document.querySelectorAll("[data-driver-view]").forEach(el => {
          if (el.id === "driverSummaryView" || el.id === "driverDetailsView") {
            el.style.display = el.getAttribute("data-driver-view") === view ? "" : "none";
          }
        });
      });
    });
  }

  populateFileSelect();

  document.getElementById("fileSelect").addEventListener("change", async e => {
    const path = e.target.value;
    if (!path) return;
    try {
      const res = await fetch(path);
      const json = await res.json();
      buildPage(json);
    } catch (err) {
      console.error(err);
      alert("Failed to load JSON: " + err.message);
    }
  });
</script>
</body>
</html>
