<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TTRL – Season Data</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #050608;
      --bg-elevated: #0b1018;
      --bg-card: #050a12;
      --border-subtle: #1f2937;
      --border-strong: #374151;
      --text-main: #f9fafb;
      --text-subtle: #9ca3af;
      --accent: #2563eb;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      padding:16px 18px 32px;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:var(--bg);
      color:var(--text-main);
    }
    h1 { margin:0 0 6px; font-size:22px; }
    .page-sub {
      margin:0 0 16px;
      font-size:13px;
      color:var(--text-subtle);
    }

    .bar-line {
      height:2px;
      background:#0f172a;
      margin:8px 0 18px;
    }

    .top-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }

    .label {
      font-size:13px;
      color:var(--text-subtle);
    }

    .file-input {
      padding:4px 6px;
      font-size:13px;
      border-radius:6px;
      border:1px solid var(--border-subtle);
      background:#020617;
      color:var(--text-main);
    }

    .driver-select {
      padding:4px 6px;
      font-size:13px;
      border-radius:6px;
      border:1px solid var(--border-subtle);
      background:#020617;
      color:var(--text-main);
      min-width:190px;
    }

    .tabs {
      display:inline-flex;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      padding:2px;
      gap:2px;
      margin-top:4px;
    }
    .tab-button {
      border:none;
      background:transparent;
      color:var(--text-subtle);
      font-size:13px;
      padding:4px 12px;
      border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
    }
    .tab-button.active {
      background:var(--accent);
      color:#f9fafb;
    }

    .layout {
      display:grid;
      grid-template-columns:minmax(0,1.8fr) minmax(0,2.2fr);
      gap:14px;
    }
    @media (max-width:960px){ .layout{grid-template-columns:1fr;} }

    .card {
      background:var(--bg-elevated);
      border-radius:12px;
      border:1px solid var(--border-strong);
      padding:14px 16px;
    }

    /* left: driver list */
    .driver-list {
      max-height:520px;
      overflow-y:auto;
    }
    .driver-row {
      background:var(--bg-card);
      border-radius:10px;
      border:1px solid var(--border-subtle);
      padding:8px 10px;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .driver-row.active {
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,0.4);
    }
    .driver-main {
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:13px;
    }
    .driver-name { font-weight:600; }
    .driver-meta { font-size:11px; color:var(--text-subtle); }

    .driver-pill-row {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:4px;
      font-size:11px;
    }
    .driver-pill {
      padding:2px 7px;
      border-radius:999px;
      background:#111827;
      border:1px solid #374151;
    }

    .pos-pill {
      padding:2px 7px;
      border-radius:999px;
      background:#facc15;
      color:#111827;
      font-size:11px;
      font-weight:600;
    }

    /* right: detail cards */
    .detail-grid {
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:640px){ .detail-grid{grid-template-columns:1fr;} }
    .dd-card {
      background:var(--bg-card);
      border-radius:10px;
      border:1px solid var(--border-subtle);
      padding:8px 10px;
    }
    .dd-title {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--text-subtle);
      margin-bottom:4px;
    }
    .dd-table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .dd-table td{padding:2px 0;border:none;}
    .dd-table td:first-child{color:var(--text-subtle);}
    .dd-table td:last-child{text-align:right;}

    .seasons-label {
      font-size:11px;
      letter-spacing:0.15em;
      text-transform:uppercase;
      color:var(--text-subtle);
      margin:10px 0 4px;
    }
    .season-row {
      background:var(--bg-card);
      border-radius:8px;
      border:1px solid var(--border-subtle);
      padding:5px 10px;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      min-height:26px;
    }
    .season-main {
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:12px;
    }
    .season-name { font-weight:500; }
    .season-meta {
      font-size:11px;
      color:var(--text-subtle);
    }
    .season-meta span+span::before{content:"•";margin:0 4px;}
    .season-right {
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
      font-size:11px;
    }
    .season-pos-pill {
      padding:1px 7px;
      border-radius:999px;
      background:#facc15;
      color:#111827;
      font-size:10px;
      font-weight:600;
      letter-spacing:0.05em;
      text-transform:uppercase;
    }
  </style>
</head>
<body>
  <h1>Overview</h1>
  <p class="page-sub">
    Load a multi-season export JSON, then pick a driver to view their TTRL career.
  </p>
  <div class="bar-line"></div>

  <div class="top-row">
    <span class="label">JSON file</span>
    <input id="jsonFileInput" class="file-input" type="file"
           accept=".json,application/json">

    <span class="label">Driver</span>
    <select id="driverSelect" class="driver-select" disabled>
      <option value="">Select driver…</option>
    </select>

    <div class="tabs">
      <button type="button" class="tab-button active">
        Drivers
      </button>
      <button type="button" class="tab-button"
              onclick="openDriverSummaryView()">
        Individual Driver Summary
      </button>
      <button type="button" class="tab-button" disabled>
        Tracks (coming soon)
      </button>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: driver list -->
    <div class="card">
      <div class="driver-list" id="driverList"></div>
    </div>

    <!-- RIGHT: selected driver detail -->
    <div class="card" id="detailCard" style="display:none;">
      <div class="detail-grid">
        <div class="dd-card">
          <div class="dd-title">Career</div>
          <table class="dd-table" id="tblCareer"></table>
        </div>
        <div class="dd-card">
          <div class="dd-title">Races</div>
          <table class="dd-table" id="tblRaces"></table>
        </div>
        <div class="dd-card">
          <div class="dd-title">Points</div>
          <table class="dd-table" id="tblPoints"></table>
        </div>
      </div>

      <div class="seasons-label">Seasons</div>
      <div id="detailSeasons"></div>
    </div>
  </div>

<script>
let driversSrc = [];
let driverRowsAll = [];

// globals used to hand state to driver-summary.html
window.currentExportFilename = '';
window.currentDriverName = '';

function safeNum(v, fallback = 0) {
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}

function deriveDriverRow(d) {
  const infoD = d.driverInfo || {};
  const points = d.points || {};
  const racePositions = d.racePositions || {};
  const discipline = d.discipline || {};
  const participation = d.participation || {};
  const standings = d.standings || {};
  return {
    source: d,
    id: d.driverId,
    name: d.driverName || infoD.realName || '',
    nationality: infoD.nationality || '',
    raceNumber: infoD.raceNumber || '',
    seasons: participation.seasonsParticipated || 0,
    totalPoints: safeNum(points.totalPoints),
    wins: safeNum(racePositions.wins),
    podiums: safeNum(racePositions.podiums),
    bestChampPos: standings.bestPosition || '',
    avgFinish: racePositions.averagePosition,
    cleanPct: discipline.cleanRacePercent
  };
}

function fillTable(elId, rows) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.innerHTML = rows.map(r =>
    '<tr><td>' + r.label + '</td><td>' + (r.value ?? '') + '</td></tr>'
  ).join('');
}

function renderDriverList() {
  const list = document.getElementById('driverList');
  const sel = document.getElementById('driverSelect');
  list.innerHTML = '';
  sel.innerHTML = '<option value="">Select driver…</option>';

  const sorted = driverRowsAll.slice().sort((a,b) =>
    a.name.localeCompare(b.name)
  );

  sorted.forEach(row => {
    if (!row.name) return;

    // select option
    const opt = document.createElement('option');
    opt.value = row.id;
    opt.textContent = row.name;
    sel.appendChild(opt);

    // list row
    const div = document.createElement('div');
    div.className = 'driver-row';
    div.dataset.id = row.id;

    const main = document.createElement('div');
    main.className = 'driver-main';
    const nameEl = document.createElement('div');
    nameEl.className = 'driver-name';
    nameEl.textContent = row.name;
    main.appendChild(nameEl);

    const meta = document.createElement('div');
    meta.className = 'driver-meta';
    const bits = [];
    if (row.nationality) bits.push(row.nationality);
    if (row.raceNumber) bits.push('#' + row.raceNumber);
    if (row.seasons) bits.push(row.seasons + ' seasons');
    meta.innerHTML = bits.join(' • ');
    main.appendChild(meta);

    const pillRow = document.createElement('div');
    pillRow.className = 'driver-pill-row';
    pillRow.innerHTML =
      '<span class="driver-pill">Pts: ' + row.totalPoints + '</span>' +
      '<span class="driver-pill">Wins: ' + row.wins + '</span>' +
      '<span class="driver-pill">Podiums: ' + row.podiums + '</span>';
    main.appendChild(pillRow);

    div.appendChild(main);

    const posPill = document.createElement('div');
    posPill.className = 'pos-pill';
    posPill.textContent = row.bestChampPos ? 'P' + row.bestChampPos : '—';
    div.appendChild(posPill);

    div.addEventListener('click', () => {
      document.querySelectorAll('.driver-row.active')
        .forEach(el => el.classList.remove('active'));
      div.classList.add('active');
      document.getElementById('driverSelect').value = row.id;
      window.currentDriverName = row.name;
      renderDriverDetail(row.id);
    });

    list.appendChild(div);
  });

  sel.disabled = sorted.length === 0;
}

function renderDriverDetail(id) {
  const row = driverRowsAll.find(d => String(d.id) === String(id));
  const detailCard = document.getElementById('detailCard');
  if (!row) {
    detailCard.style.display = 'none';
    return;
  }
  const src = row.source;
  const participation = src.participation || {};
  const standings = src.standings || {};
  const points = src.points || {};
  const racePositions = src.racePositions || {};
  const qualPositions = src.qualPositions || {};
  const discipline = src.discipline || {};
  const seasons = standings.seasonResults || [];

  detailCard.style.display = '';

  fillTable('tblCareer', [
    { label:'Races', value: participation.totalRaces ?? '' },
    { label:'Seasons', value: participation.seasonsParticipated ?? '' },
    { label:'Titles', value: standings.championshipsWon ?? '' },
    { label:'Top 3', value: standings.top3Finishes ?? '' },
    { label:'Best standings', value: standings.bestPosition ?? '' },
    { label:'Avg standings', value: standings.averagePosition ?? '' }
  ]);

  fillTable('tblRaces', [
    { label:'Wins', value: racePositions.wins ?? '' },
    { label:'Podiums', value: racePositions.podiums ?? '' },
    { label:'Top 5', value: racePositions.top5 ?? '' },
    { label:'Top 10', value: racePositions.top10 ?? '' },
    { label:'Best finish', value: racePositions.bestPosition != null ?
        'P' + racePositions.bestPosition : '' },
    { label:'Avg finish', value: racePositions.averagePosition ?? '' },
    { label:'Avg grid', value: racePositions.averageGridPosition ?? '' },
    { label:'Avg pos change', value: racePositions.averagePositionChange != null ?
        (racePositions.averagePositionChange > 0 ? '+' : '') +
        racePositions.averagePositionChange : '' }
  ]);

  fillTable('tblPoints', [
    { label:'Total points', value: points.totalPoints ?? '' },
    { label:'Avg per season', value: points.averagePerSeason ?? '' },
    { label:'Avg per race', value: points.averagePerMajorRace ?? '' },
    { label:'Avg per event', value: points.averagePerEvent ?? '' },
    { label:'Best season', value: points.bestSeasonPoints ?
        points.bestSeasonPoints + ' (' + (points.bestSeasonName || '') + ')' : '' }
  ]);

  const seasonsEl = document.getElementById('detailSeasons');
  seasonsEl.innerHTML = '';
  seasons.slice().sort((a,b) =>
    String(a.seasonName || '').localeCompare(String(b.seasonName || ''))
  ).forEach(s => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'season-row';

    const left = document.createElement('div');
    left.className = 'season-main';

    const title = document.createElement('div');
    title.className = 'season-name';
    title.textContent = s.seasonName || '';
    left.appendChild(title);

    const meta = document.createElement('div');
    meta.className = 'season-meta';
    const eventsVal = s.racesCount != null ? s.racesCount : 0;
    meta.innerHTML =
      '<span>' + eventsVal + ' events</span>' +
      '<span>' + (s.points || 0) + ' pts</span>';
    left.appendChild(meta);

    rowDiv.appendChild(left);

    const right = document.createElement('div');
    right.className = 'season-right';

    const pos = document.createElement('div');
    pos.className = 'season-pos-pill';
    pos.textContent = 'P' + (s.position || '–');
    right.appendChild(pos);

    if (s.wins != null) {
      const win = document.createElement('div');
      win.textContent = s.wins + ' wins';
      right.appendChild(win);
    }

    rowDiv.appendChild(right);
    seasonsEl.appendChild(rowDiv);
  });
}

/* file load */
document.getElementById('jsonFileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  window.currentExportFilename = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      const multi = data.multiSeasonStatistics || {};
      driversSrc = multi.drivers || multi.driverStatistics || data.drivers || [];
      driverRowsAll = driversSrc.map(deriveDriverRow);
      renderDriverList();
      document.getElementById('detailCard').style.display = 'none';
      window.currentDriverName = '';
    } catch (err) {
      alert('Failed to parse JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
});

/* driver select dropdown */
document.getElementById('driverSelect').addEventListener('change', e => {
  const id = e.target.value;
  if (!id) {
    document.getElementById('detailCard').style.display = 'none';
    window.currentDriverName = '';
    return;
  }
  const row = driverRowsAll.find(d => String(d.id) === String(id));
  if (row) {
    window.currentDriverName = row.name;
  }
  document.querySelectorAll('.driver-row.active')
    .forEach(el => el.classList.remove('active'));
  const el = document.querySelector('.driver-row[data-id="' + id + '"]');
  if (el) el.classList.add('active');
  renderDriverDetail(id);
});

/* ---- navigation to driver-summary.html ---- */

function openDriverSummaryView() {
  const jsonFilename = window.currentExportFilename || '';
  const driverName   = window.currentDriverName || '';

  if (!jsonFilename || !driverName) {
    alert('Pick a JSON file and a driver first.');
    return;
  }

  localStorage.setItem('ttrl_selected_json', jsonFilename);
  localStorage.setItem('ttrl_selected_driver', driverName);

  window.location.href = 'driver-summary.html?from=index';
}
</script>
</body>
</html>
