<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TTRL – Race Report</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: radial-gradient(circle at top, #222 0, #000 55%);
      color: #f8f9fa;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .race-header {
      border-bottom: 2px solid #dc3545;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
    }
    .race-header h1 {
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 1.6rem;
    }
    .badge-track {
      background: #0d6efd;
    }
    .badge-sprint {
      background: #ffc107;
      color: #000;
    }
    .card-session {
      background: rgba(15, 15, 15, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
    }
    .table-results {
      background: rgba(0, 0, 0, 0.6);
    }
    .table-results thead {
      background: linear-gradient(90deg, #dc3545, #0d6efd);
    }
    .table-results tbody tr:nth-child(odd) {
      background-color: rgba(255, 255, 255, 0.02);
    }
    .table-results tbody tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .fastest-lap {
      color: #0d6efd;
      font-weight: 600;
    }
    .pill-team {
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .pill-status-ok {
      color: #20c997;
    }
    .pill-status-dnf {
      color: #ffc107;
    }
    .loading,
    .error {
      text-align: center;
      margin-top: 2rem;
      color: #adb5bd;
    }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- HEADER -->
    <header class="race-header d-flex justify-content-between align-items-center">
      <div>
        <h1 class="mb-1">Race Report</h1>
        <div class="small text-muted">
          <span id="trackLabel" class="badge badge-track me-1"></span>
          <span id="sessionLabel" class="badge badge-sprint me-1"></span>
          <span id="dateLabel"></span>
        </div>
      </div>
      <div class="text-end small">
        <div>Weather: <span id="weatherLabel"></span></div>
        <div>Air: <span id="airTempLabel"></span>°C · Track: <span id="trackTempLabel"></span>°C</div>
        <div>Laps: <span id="lapsLabel"></span> · Duration: <span id="durationLabel"></span></div>
      </div>
    </header>

    <!-- SESSION SUMMARY -->
    <section class="mb-4">
      <div class="card card-session">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">Session Summary</h5>
            <p class="card-text mb-0 small">
              <strong>Type:</strong> <span id="sessionType"></span> ·
              <strong>Status:</strong> <span id="sessionStatus"></span> ·
              <strong>Position in event:</strong> <span id="sessionPosition"></span>
            </p>
          </div>
          <div class="text-end">
            <div class="small">Fastest Lap</div>
            <div class="fastest-lap" id="fastestLapLine"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTS TABLE -->
    <section id="resultsSection" style="display:none;">
      <div class="card card-session">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Classification</h5>
          <div class="small text-muted">Finishers: <span id="finishersCount"></span></div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-dark table-results mb-0 table-sm align-middle">
              <thead>
                <tr>
                  <th scope="col" class="text-center">Pos</th>
                  <th scope="col">Driver</th>
                  <th scope="col">Team</th>
                  <th scope="col" class="text-center">No</th>
                  <th scope="col" class="text-center">Grid</th>
                  <th scope="col" class="text-center">Laps</th>
                  <th scope="col" class="text-end">Race Time</th>
                  <th scope="col" class="text-end">Fastest Lap</th>
                  <th scope="col" class="text-center">Pen</th>
                  <th scope="col" class="text-center">Pts</th>
                  <th scope="col" class="text-center">Status</th>
                </tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div id="loadingMessage" class="loading">
      Loading race data…
    </div>
    <div id="errorMessage" class="error" style="display:none;">
      Could not load race JSON. Check the <code>?file=</code> parameter and path.
    </div>
  </div>

  <!-- JS: load JSON and render -->
  <script>
    const params = new URLSearchParams(window.location.search);
    // Default JSON file if ?file= is not provided:
   const jsonFile = params.get("file") || "RaceData/latest_sun_t1.json";

    let raceData = null;

    function msToTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const millis = ms % 1000;
      return (
        minutes.toString().padStart(2, "0") +
        ":" +
        seconds.toString().padStart(2, "0") +
        "." +
        millis.toString().padStart(3, "0")
      );
    }

    function formatDate(iso) {
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleString(undefined, {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function renderRaceReport() {
      const data = raceData;

      // Header
      document.getElementById("trackLabel").textContent = data.TrackName || "";
      document.getElementById("sessionLabel").textContent =
        (data.RaceType || "") + " " + (data.SessionType || "");
      document.getElementById("dateLabel").textContent = formatDate(data.Date);

      document.getElementById("weatherLabel").textContent = data.WeatherType || "";
      document.getElementById("airTempLabel").textContent = data.AirTemperature ?? "";
      document.getElementById("trackTempLabel").textContent = data.TrackTemperature ?? "";
      document.getElementById("lapsLabel").textContent = data.TotalLaps ?? "";
      document.getElementById("durationLabel").textContent = data.SessionDuration || "";

      document.getElementById("sessionType").textContent =
        (data.RaceType || "") + " " + (data.SessionType || "");
      document.getElementById("sessionStatus").textContent = data.SessionStatus || "";
      document.getElementById("sessionPosition").textContent = data.SessionPosition ?? "";

      const flDriver = (data.FastestLapDriver && data.FastestLapDriver.Name || "").trim();
      const flTime = data.FastestLapTimeInt ? msToTime(data.FastestLapTimeInt) : "N/A";
      const flLap = data.FastestLapNumLap ?? "?";
      document.getElementById("fastestLapLine").textContent =
        flDriver ? `${flDriver} – ${flTime} (Lap ${flLap})` : "N/A";

      // Results
      const body = document.getElementById("resultsBody");
      body.innerHTML = "";

      const drivers = Array.isArray(data.Drivers) ? data.Drivers.slice() : [];
      drivers.sort((a, b) => (a.Position || 999) - (b.Position || 999));

      document.getElementById("finishersCount").textContent = drivers.length;
      document.getElementById("resultsSection").style.display = "";

      for (const d of drivers) {
        const tr = document.createElement("tr");

        const status = d.Status || "Unknown";
        const statusClass = status === "Ok" ? "pill-status-ok" : "pill-status-dnf";

        const penSecs =
          (d.PenaltySecsIngame || 0) + (d.PenaltySecsStewards || 0);
        const points = d.DriverPointsRaw ?? 0;

        const driverName = d.DriverNameIngame || (d.Driver && d.Driver.Name) || "";
        const nat = d.NationalityIngame || "";
        const teamName = (d.Team && d.Team.Name) || "";

        tr.innerHTML = `
          <td class="text-center fw-bold">${d.Position ?? ""}</td>
          <td>
            <div>${driverName}</div>
            <div class="small text-muted">${nat}</div>
          </td>
          <td>
            <span class="pill-team">${teamName}</span>
          </td>
          <td class="text-center">${d.RaceNumber ?? ""}</td>
          <td class="text-center">${d.GridPosition ?? ""}</td>
          <td class="text-center">${d.LapsCount ?? ""}</td>
          <td class="text-end">${d.TimeInt ? msToTime(d.TimeInt) : ""}</td>
          <td class="text-end">
            ${d.FastestLapTimeInt ? msToTime(d.FastestLapTimeInt) : ""}
            <span class="small text-muted">${d.FastestLapTyres || ""}</span>
          </td>
          <td class="text-center">${penSecs}</td>
          <td class="text-center">${points}</td>
          <td class="text-center">
            <span class="${statusClass} small">${status}</span>
          </td>
        `;

        body.appendChild(tr);
      }
    }

    fetch(jsonFile)
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(data => {
        raceData = data;
        document.getElementById("loadingMessage").style.display = "none";
        renderRaceReport();
      })
      .catch(err => {
        console.error("Failed to load race JSON", err);
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("errorMessage").style.display = "";
      });
  </script>
</body>
</html>
